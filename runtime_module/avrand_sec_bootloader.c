/*
 *            AVRAND safe bootloader
 *            Copyright 2016 Sergio Pastrana (spastran [at] inf [dot] uc3m [dot] es)
 *            More info at www.seg.inf.uc3m.es/~spastran/avrand
 *
 *            Macros, SetupHardware and main function adapted from Dean Camera's Caterina bootloader
 *            
 *            Tested on an Atmel atmega32u4 chip, though it should work in any 8-bit AVR with external EEPROM and at least 4KB of space in the bootloader section 
*/

/* Includes: */
#include <avr/io.h>
#include <avr/wdt.h>
#include <avr/boot.h>
#include <avr/eeprom.h>
#include <avr/power.h>
#include <avr/interrupt.h>
#include <LUFA/Drivers/USB/USB.h>


/* Macros: */
#define CPU_PRESCALE(n)	(CLKPR = 0x80, CLKPR = (n))
#define LED_SETUP()		DDRC |= (1<<7); DDRB |= (1<<0); DDRD |= (1<<5);
#define L_LED_OFF()		PORTC &= ~(1<<7)
#define L_LED_ON()		PORTC |= (1<<7)
#define L_LED_TOGGLE()	PORTC ^= (1<<7)
#if DEVICE_PID == 0x0037	// polarity of the RX and TX LEDs is reversed on the Micro
	#define TX_LED_OFF()	PORTD &= ~(1<<5)
	#define TX_LED_ON()		PORTD |= (1<<5)
	#define RX_LED_OFF()	PORTB &= ~(1<<0)
	#define RX_LED_ON()		PORTB |= (1<<0)			
#else 
	#define TX_LED_OFF()	PORTD |= (1<<5)
	#define TX_LED_ON()		PORTD &= ~(1<<5)
	#define RX_LED_OFF()	PORTB |= (1<<0)
	#define RX_LED_ON()		PORTB &= ~(1<<0)
#endif

/* Function Prototypes: */
void CDC_Task(void);
void SetupHardware(void);
void randomizeBinary(void);

void main (void) __attribute__ ((section (".main")));
void cryptXOR (void) __attribute__ ((section (".main")));
void mainFunctionality(void);
void boot_program_page (uint32_t page, uint8_t *buf) __attribute__ ((section (".main")));
void createSeed();

//FROM NOW; THE KEY IS STATIC;
//Todo: modify key in the randomization engine...
//

__attribute__ ((used,section (".secretKey"))) const uint8_t key[SPM_PAGESIZE]={0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa};

// Decryption and encryption routine. It encrypts page where bootloader's main functionality starts (i.e  from 0x7100, page 226) to page where main begins (i.e. 0x7eaa), minus 1 (page 252)
void cryptXOR(){
	uint8_t numPage,i;
	uint8_t A [SPM_PAGESIZE];
	uint8_t initPage=226;//(0x7100)/SPM_PAGESIZE;
	uint8_t endPage=252;//251;//(0x7e00-SPM_PAGESIZE)/SPM_PAGESIZE;
	for (numPage=initPage;numPage<=endPage;numPage++){
		for ( i = 0; i < SPM_PAGESIZE; i++){
			A [i] = pgm_read_byte (numPage*SPM_PAGESIZE+i) ^ pgm_read_byte(&(key[i]));
		}
		boot_program_page(numPage*SPM_PAGESIZE,A);
	}
}
/** Main program entry point. This routine decrypts the remainder of the bootloader and jumps to the main routine.
 */
void main (void){
	
	MCUSR = 0;	// clear all reset flags	

	/* Watchdog may be configured with a 15 ms period so must disable it before going any further */
	wdt_disable();
	
	//DECRYPTION
	cryptXOR();

	//EXECUTE MAIN FUNCTIONS
	mainFunctionality();
	
	//ENCRYPT AGAIN
	cryptXOR();

	//----------------------
	// Start Program 
	//----------------------	
	/* Jump to beginning of application space to run the program - do not reset */	
	cli();
	/* Undo TIMER1 setup and clear the count before running the program */
	TIMSK1 = 0;
	TCCR1B = 0;
	TCNT1H = 0;		// 16-bit write to TCNT1 requires high byte be written first
	TCNT1L = 0;

	/* Relocate the interrupt vector table to the application section */
	MCUCR = (1 << IVCE);
	MCUCR = 0;

	L_LED_OFF();
	TX_LED_OFF();
	RX_LED_OFF();

	/* jump to beginning of application space */
	__asm__ volatile("jmp 0x0000");
	//----------------------	
	//----------------------	

}


/** Main program entry point. This routine configures the hardware required by the bootloader, then randomizes the code
  * and jumps to the application code section at 0x0000
 */
void mainFunctionality(void)
{	
	// SetupHardware: Setup hardware required for the bootloader
	/* Disable watchdog if enabled by bootloader/fuses */
	MCUSR &= ~(1 << WDRF);
	wdt_disable();

	/* Disable clock division */
	clock_prescale_set(clock_div_1);

	/* Relocate the interrupt vector table to the bootloader section */
	MCUCR = (1 << IVCE);
	MCUCR = (1 << IVSEL);
	
	LED_SETUP();
	CPU_PRESCALE(0); 
	L_LED_OFF();
	TX_LED_OFF();
	RX_LED_OFF();

	/* Initialize USB Subsystem */
	USB_Init();
	/* Enable global interrupts so that the USB stack can function */
	sei();
	// SetupHardware

	randomizeBinary();
	USB_USBTask();


	/* Disconnect from the host - USB interface will be reset later along with the AVR */
	USB_Detach();
}

void boot_program_page (uint32_t page, uint8_t *buf){
        uint16_t i;
        uint8_t sreg;

        // Disable interrupts.

        sreg = SREG;
        cli();
    
        eeprom_busy_wait ();

        boot_page_erase (page);
        boot_spm_busy_wait ();      // Wait until the memory is erased.

        for (i=0; i<SPM_PAGESIZE; i+=2)
        {
            // Set up little-endian word.

            uint16_t w = *buf++;
            w += (*buf++) << 8;
        
            boot_page_fill (page + i, w);
        }

        boot_page_write (page);     // Store buffer in flash page.
        boot_spm_busy_wait();       // Wait until the memory is written.

        // Reenable RWW-section again. We need this if we want to jump back
        // to the application after bootloading.

        boot_rww_enable ();

        // Re-enable interrupts (if they were ever enabled).
        SREG = sreg;
    }

//---------- INIT: COPIED FROM OUTPUT OF PYTHON SCRIPT WHICH PREPROCESSES THE HEX FILE-------------

__attribute__ ((used,section (".absolutePointers"))) const uint8_t pageOffsets[3417]={ 0x0,0x0,0x4, 0x0,0x2,0x5, 0x0,0x4,0x5, 0x0,0x6,0x5, 0x0,0x8,0x5, 0x0,0xa,0x5, 0x0,0xc,0x5, 0x0,0xe,0x5, 0x0,0x10,0x5, 0x0,0x12,0x5, 0x0,0x14,0x42, 0x0,0x16,0x3b, 0x0,0x18,0x5, 0x0,0x1a,0x5, 0x0,0x1c,0x5, 0x0,0x1e,0x5, 0x0,0x20,0x5, 0x0,0x22,0x5, 0x0,0x24,0x5, 0x0,0x26,0x5, 0x0,0x28,0x5, 0x0,0x2a,0x5, 0x0,0x2c,0x5, 0x0,0x2e,0x60, 0x0,0x30,0x5, 0x0,0x32,0x6b, 0x0,0x34,0x6c, 0x0,0x36,0x5, 0x0,0x38,0x5, 0x0,0x3a,0x5, 0x0,0x3c,0x5, 0x0,0x3e,0x5, 0x1,0x0,0x5, 0x1,0x2,0x5, 0x1,0x4,0x5, 0x1,0x6,0x5, 0x1,0x8,0x5, 0x1,0xa,0x5, 0x1,0xc,0x5, 0x1,0xe,0x5, 0x1,0x10,0x5, 0x1,0x12,0x5, 0x1,0x14,0x5, 0x4,0x32,0x4, 0x4,0x3a,0x4, 0x4,0x3e,0x5, 0x5,0x1,0x5, 0x5,0x8,0x5, 0x5,0xd,0x5, 0x5,0x11,0x89, 0x5,0x17,0x5, 0x5,0x19,0x48, 0x5,0x1b,0x78, 0x5,0x1d,0x0, 0x5,0x25,0x24, 0x5,0x30,0x29, 0x5,0x34,0x52, 0x5,0x38,0x24, 0x5,0x3e,0x6, 0x6,0x2,0x5, 0x6,0x21,0x2c, 0x6,0x29,0x30, 0x6,0x37,0x79, 0x6,0x3e,0x7, 0x7,0x5,0x79, 0x7,0xa,0x2c, 0x7,0x10,0x2c, 0x7,0x29,0x7, 0x7,0x2b,0x9, 0x7,0x31,0x7, 0x7,0x33,0x9, 0x7,0x39,0x2c, 0x7,0x3e,0x8, 0x8,0x5,0x8, 0x8,0x8,0x84, 0x8,0xf,0x8, 0x8,0x15,0x2c, 0x8,0x17,0x8, 0x8,0x1c,0x2c, 0x8,0x21,0x8, 0x8,0x25,0x2d, 0x8,0x2d,0x79, 0x8,0x35,0x79, 0x8,0x3a,0x2c, 0x8,0x3e,0x9, 0x9,0x2,0x2c, 0x9,0x9,0x9, 0x9,0x11,0x9, 0x9,0x17,0x9, 0x9,0x1d,0x2c, 0x9,0x20,0x84, 0x9,0x29,0x79, 0x9,0x35,0x79, 0x9,0x3b,0x2c, 0x9,0x3e,0xa, 0xa,0x3,0x2c, 0xa,0x9,0x2c, 0xa,0x17,0xa, 0xa,0x19,0x7, 0xa,0x26,0xb, 0xa,0x2c,0x2c, 0xa,0x34,0xa, 0xa,0x3a,0x2c, 0xa,0x3e,0xb, 0xb,0x0,0xa, 0xb,0x6,0x2c, 0xb,0xa,0x84, 0xb,0x11,0xb, 0xb,0x17,0x2c, 0xb,0x19,0xb, 0xb,0x1e,0x2c, 0xb,0x22,0x2d, 0xb,0x3e,0xc, 0xc,0x1e,0xc, 0xc,0x28,0x2c, 0xc,0x30,0x30, 0xc,0x3e,0xd, 0xd,0x0,0x79, 0xd,0xc,0x79, 0xd,0x11,0x2c, 0xd,0x17,0x2c, 0xd,0x24,0xd, 0xd,0x26,0x10, 0xd,0x31,0xd, 0xd,0x33,0xf, 0xd,0x39,0xd, 0xd,0x3b,0xf, 0xd,0x3e,0xe, 0xe,0x3,0x2c, 0xe,0xd,0xe, 0xe,0x18,0xe, 0xe,0x1e,0x2c, 0xe,0x20,0xe, 0xe,0x24,0x2c, 0xe,0x26,0xe, 0xe,0x2a,0x2d, 0xe,0x35,0x79, 0xe,0x3e,0xf, 0xf,0x0,0x79, 0xf,0x5,0x2c, 0xf,0xb,0x2c, 0xf,0x12,0xf, 0xf,0x1a,0xf, 0xf,0x20,0xf, 0xf,0x26,0x2c, 0xf,0x33,0x79, 0xf,0x3e,0x10, 0x10,0x1,0x79, 0x10,0x8,0x2c, 0x10,0xe,0x2c, 0x10,0x14,0x2c, 0x10,0x21,0xd, 0x10,0x2e,0x11, 0x10,0x34,0x2c, 0x10,0x3b,0x11, 0x10,0x3e,0x11, 0x11,0x3,0x2c, 0x11,0x8,0x10, 0x11,0xe,0x2c, 0x11,0x19,0x11, 0x11,0x24,0x11, 0x11,0x2a,0x2c, 0x11,0x2c,0x11, 0x11,0x30,0x2c, 0x11,0x34,0x11, 0x11,0x38,0x2d, 0x11,0x3e,0x12, 0x12,0x24,0x12, 0x12,0x2e,0x2c, 0x12,0x36,0x31, 0x12,0x3c,0x2c, 0x12,0x3e,0x13, 0x13,0x6,0x30, 0x13,0xd,0x30, 0x13,0x13,0x2c, 0x13,0x1b,0x13, 0x13,0x1d,0x15, 0x13,0x25,0x14, 0x13,0x2b,0x14, 0x13,0x31,0x2c, 0x13,0x3b,0x14, 0x13,0x3e,0x14, 0x14,0x7,0x14, 0x14,0xd,0x2c, 0x14,0xf,0x13, 0x14,0x13,0x2c, 0x14,0x15,0x13, 0x14,0x19,0x2d, 0x14,0x20,0x30, 0x14,0x24,0x14, 0x14,0x2c,0x14, 0x14,0x32,0x14, 0x14,0x38,0x2c, 0x14,0x3e,0x15, 0x15,0x2,0x15, 0x15,0x8,0x2c, 0x15,0xf,0x31, 0x15,0x15,0x2c, 0x15,0x19,0x13, 0x15,0x26,0x16, 0x15,0x2c,0x2c, 0x15,0x33,0x15, 0x15,0x39,0x2c, 0x15,0x3e,0x16, 0x16,0x0,0x15, 0x16,0x6,0x2c, 0x16,0x10,0x16, 0x16,0x18,0x16, 0x16,0x1e,0x2c, 0x16,0x20,0x16, 0x16,0x24,0x2c, 0x16,0x26,0x16, 0x16,0x32,0x2d, 0x16,0x3e,0x17, 0x17,0x1,0x2d, 0x17,0x7,0x2c, 0x17,0xe,0x30, 0x17,0x14,0x2c, 0x17,0x1d,0x17, 0x17,0x1f,0x19, 0x17,0x27,0x18, 0x17,0x2d,0x18, 0x17,0x33,0x2c, 0x17,0x3e,0x18, 0x18,0x2,0x18, 0x18,0xc,0x18, 0x18,0x12,0x2c, 0x18,0x14,0x17, 0x18,0x18,0x2c, 0x18,0x1a,0x17, 0x18,0x1e,0x2d, 0x18,0x24,0x2c, 0x18,0x2b,0x30, 0x18,0x2f,0x19, 0x18,0x37,0x19, 0x18,0x3e,0x19, 0x19,0x2,0x19, 0x19,0x8,0x2c, 0x19,0xe,0x19, 0x19,0x14,0x2c, 0x19,0x1b,0x31, 0x19,0x21,0x2c, 0x19,0x25,0x17, 0x19,0x32,0x1a, 0x19,0x38,0x2c, 0x19,0x3e,0x1a, 0x1a,0x2,0x1a, 0x1a,0x8,0x2c, 0x1a,0xb,0x19, 0x1a,0x11,0x2c, 0x1a,0x1a,0x1a, 0x1a,0x22,0x1a, 0x1a,0x28,0x2c, 0x1a,0x2a,0x1a, 0x1a,0x2e,0x2c, 0x1a,0x30,0x1a, 0x1a,0x3a,0x2d, 0x1a,0x3e,0x1b, 0x1b,0x23,0x5e, 0x1b,0x33,0x16, 0x1b,0x37,0x21, 0x1b,0x3c,0x1b, 0x1b,0x3e,0x1c, 0x1c,0x4,0x21, 0x1c,0x9,0x1c, 0x1c,0xd,0x21, 0x1c,0x18,0x1c, 0x1c,0x1c,0x16, 0x1c,0x2d,0x5c, 0x1c,0x30,0x1c, 0x1c,0x34,0x2d, 0x1c,0x38,0x59, 0x1c,0x3e,0x1d, 0x1d,0x2,0x1d, 0x1d,0x6,0x59, 0x1d,0xb,0x2c, 0x1d,0xd,0x1c, 0x1d,0x11,0x21, 0x1d,0x1e,0x46, 0x1d,0x25,0x5f, 0x1d,0x29,0x44, 0x1d,0x2b,0x1c, 0x1d,0x3c,0x2d, 0x1d,0x3e,0x1e, 0x1e,0x4,0x2d, 0x1e,0xa,0x2d, 0x1e,0x10,0x2d, 0x1e,0x16,0x2d, 0x1e,0x1c,0x2d, 0x1e,0x22,0x2d, 0x1e,0x26,0x21, 0x1e,0x2b,0x1e, 0x1e,0x2f,0x21, 0x1e,0x34,0x21, 0x1e,0x39,0x1f, 0x1e,0x3e,0x1f, 0x1f,0x3,0x12, 0x1f,0x8,0x1f, 0x1f,0x10,0xb, 0x1f,0x15,0x1f, 0x1f,0x19,0x6, 0x1f,0x1e,0x1f, 0x1f,0x24,0x2d, 0x1f,0x35,0x20, 0x1f,0x3b,0x2c, 0x1f,0x3e,0x20, 0x20,0x0,0x1b, 0x20,0x7,0x2c, 0x20,0xa,0x20, 0x20,0xe,0x20, 0x20,0x16,0x2d, 0x20,0x1b,0x20, 0x20,0x1f,0x1d, 0x20,0x25,0x2c, 0x20,0x2c,0x2d, 0x20,0x3e,0x21, 0x21,0xc,0x21, 0x21,0xf,0x35, 0x21,0x19,0x41, 0x21,0x1f,0x21, 0x21,0x22,0x34, 0x21,0x28,0x34, 0x21,0x30,0x21, 0x21,0x38,0x35, 0x21,0x3e,0x22, 0x22,0x5,0x22, 0x22,0x8,0x36, 0x22,0xe,0x22, 0x22,0x22,0x39, 0x22,0x2a,0x22, 0x22,0x2f,0x22, 0x22,0x31,0x24, 0x22,0x38,0x39, 0x22,0x3a,0x24, 0x22,0x3e,0x23, 0x23,0x2,0x24, 0x23,0x7,0x23, 0x23,0xd,0x3a, 0x23,0xf,0x23, 0x23,0x14,0x23, 0x23,0x16,0x24, 0x23,0x29,0x24, 0x23,0x2e,0x24, 0x23,0x3e,0x24, 0x24,0x3,0x24, 0x24,0x23,0x62, 0x24,0x27,0x24, 0x24,0x3e,0x25, 0x25,0x1c,0x25, 0x25,0x2d,0x25, 0x25,0x3e,0x26, 0x26,0x5,0x26, 0x26,0xc,0x26, 0x26,0xe,0x6c, 0x26,0x11,0x0, 0x26,0x2d,0x26, 0x26,0x3e,0x27, 0x27,0x2,0x27, 0x27,0x8,0x27, 0x27,0xe,0x27, 0x27,0x12,0x27, 0x27,0x16,0x27, 0x27,0x1c,0x27, 0x27,0x1f,0x26, 0x27,0x21,0x27, 0x27,0x3e,0x28, 0x28,0x1,0x28, 0x28,0x9,0x29, 0x28,0x16,0x28, 0x28,0x1a,0x28, 0x28,0x23,0x28, 0x28,0x27,0x26, 0x28,0x2a,0x28, 0x28,0x3c,0x29, 0x28,0x3e,0x29, 0x29,0x2e,0x2a, 0x29,0x36,0x87, 0x29,0x3e,0x2a, 0x2a,0x7,0x2a, 0x2a,0x12,0x87, 0x2a,0x3e,0x2b, 0x2b,0x17,0x2b, 0x2b,0x24,0x2b, 0x2b,0x34,0x2c, 0x2b,0x3b,0x2b, 0x2b,0x3e,0x2c, 0x2c,0x20,0x2c, 0x2c,0x2d,0x2c, 0x2c,0x37,0x2b, 0x2c,0x3e,0x2d, 0x2d,0x4,0x2b, 0x2d,0xb,0x2b, 0x2d,0xf,0x2d, 0x2d,0x1d,0x2c, 0x2d,0x21,0x2d, 0x2d,0x3e,0x2e, 0x2e,0xa,0x2e, 0x2e,0x19,0x87, 0x2e,0x24,0x2e, 0x2e,0x27,0x2e, 0x2e,0x32,0x2e, 0x2e,0x37,0x2e, 0x2e,0x3b,0x2b, 0x2e,0x3e,0x2f, 0x2f,0x21,0x2f, 0x2f,0x36,0x30, 0x2f,0x39,0x30, 0x2f,0x3c,0x2c, 0x2f,0x3e,0x30, 0x30,0xa,0x2d, 0x30,0x23,0x2d, 0x30,0x2b,0x2f, 0x30,0x38,0x2f, 0x30,0x3c,0x2d, 0x30,0x3e,0x31, 0x31,0xb,0x31, 0x31,0x15,0x2d, 0x31,0x1c,0x31, 0x31,0x27,0x31, 0x31,0x2b,0x2d, 0x31,0x3e,0x32, 0x32,0x2,0x32, 0x32,0x9,0x32, 0x32,0xe,0x32, 0x32,0x1c,0x32, 0x32,0x3e,0x33, 0x33,0x0,0x31, 0x33,0x3,0x31, 0x33,0xe,0x33, 0x33,0x12,0x31, 0x33,0x16,0x31, 0x33,0x1d,0x33, 0x33,0x1f,0x33, 0x33,0x2e,0x33, 0x33,0x35,0x33, 0x33,0x3e,0x34, 0x34,0xe,0x33, 0x34,0x27,0x34, 0x34,0x2a,0x34, 0x34,0x2e,0x35, 0x34,0x34,0x33, 0x34,0x3e,0x35, 0x35,0x2,0x35, 0x35,0xc,0x35, 0x35,0x14,0x35, 0x35,0x1a,0x35, 0x35,0x21,0x35, 0x35,0x26,0x35, 0x35,0x2b,0x35, 0x35,0x3e,0x36, 0x36,0x1,0x34, 0x36,0x6,0x36, 0x36,0xa,0x36, 0x36,0x1a,0x33, 0x36,0x21,0x36, 0x36,0x3e,0x37, 0x37,0x9,0x37, 0x37,0x17,0x37, 0x37,0x1b,0x39, 0x37,0x1e,0x36, 0x37,0x22,0x37, 0x37,0x27,0x37, 0x37,0x2d,0x62, 0x37,0x33,0x37, 0x37,0x35,0x39, 0x37,0x3e,0x38, 0x38,0x2,0x38, 0x38,0x8,0x33, 0x38,0xd,0x39, 0x38,0x16,0x38, 0x38,0x1d,0x39, 0x38,0x21,0x38, 0x38,0x26,0x38, 0x38,0x2b,0x38, 0x38,0x31,0x38, 0x38,0x36,0x38, 0x38,0x3b,0x38, 0x38,0x3e,0x39, 0x39,0x4,0x39, 0x39,0xa,0x39, 0x39,0xd,0x39, 0x39,0x11,0x37, 0x39,0x19,0x39, 0x39,0x1d,0x39, 0x39,0x3e,0x3a, 0x3a,0xd,0x3a, 0x3a,0x11,0x3a, 0x3a,0x14,0x3a, 0x3a,0x19,0x31, 0x3a,0x23,0x3a, 0x3a,0x27,0x3a, 0x3a,0x3e,0x3b, 0x3b,0x1,0x3a, 0x3b,0x5,0x33, 0x3b,0x1a,0x22, 0x3b,0x1e,0x65, 0x3b,0x3e,0x3c, 0x3c,0x9,0x41, 0x3c,0xe,0x33, 0x3c,0x15,0x3c, 0x3c,0x1a,0x3c, 0x3c,0x1c,0x3c, 0x3c,0x25,0x3c, 0x3c,0x27,0x40, 0x3c,0x2b,0x3c, 0x3c,0x31,0x41, 0x3c,0x38,0x3c, 0x3c,0x3a,0x41, 0x3c,0x3e,0x3d, 0x3d,0x2,0x3d, 0x3d,0x7,0x3d, 0x3d,0xd,0x41, 0x3d,0x12,0x3d, 0x3d,0x14,0x3f, 0x3d,0x1c,0x3e, 0x3d,0x21,0x39, 0x3d,0x23,0x3b, 0x3d,0x2f,0x3d, 0x3d,0x3e,0x3e, 0x3e,0x6,0x39, 0x3e,0xc,0x39, 0x3e,0xe,0x3b, 0x3e,0x10,0x41, 0x3e,0x14,0x39, 0x3e,0x1a,0x3e, 0x3e,0x1e,0x65, 0x3e,0x23,0x3e, 0x3e,0x25,0x41, 0x3e,0x27,0x41, 0x3e,0x2c,0x3f, 0x3e,0x33,0x3e, 0x3e,0x3a,0x3f, 0x3e,0x3e,0x3f, 0x3f,0x0,0x3f, 0x3f,0x5,0x3f, 0x3f,0x7,0x41, 0x3f,0xd,0x3f, 0x3f,0x12,0x3f, 0x3f,0x17,0x3f, 0x3f,0x1c,0x3f, 0x3f,0x1e,0x41, 0x3f,0x23,0x32, 0x3f,0x25,0x41, 0x3f,0x29,0x3f, 0x3f,0x31,0x3f, 0x3f,0x33,0x41, 0x3f,0x39,0x39, 0x3f,0x3b,0x41, 0x3f,0x3e,0x40, 0x40,0x2,0x40, 0x40,0x4,0x41, 0x40,0x9,0x40, 0x40,0xe,0x41, 0x40,0x13,0x41, 0x40,0x18,0x41, 0x40,0x2d,0x40, 0x40,0x37,0x41, 0x40,0x3b,0x39, 0x40,0x3e,0x41, 0x41,0x1,0x41, 0x41,0x5,0x22, 0x41,0x7,0x41, 0x41,0xc,0x41, 0x41,0x10,0x66, 0x41,0x15,0x41, 0x41,0x1a,0x41, 0x41,0x3e,0x42, 0x42,0x5,0x42, 0x42,0x21,0x42, 0x42,0x33,0x43, 0x42,0x36,0x41, 0x42,0x3e,0x43, 0x43,0x2,0x43, 0x43,0xc,0x43, 0x43,0x13,0x43, 0x43,0x1b,0x43, 0x43,0x1e,0x43, 0x43,0x21,0x43, 0x43,0x3e,0x44, 0x44,0x2,0x44, 0x44,0x8,0x62, 0x44,0x18,0x71, 0x44,0x22,0x44, 0x44,0x24,0x71, 0x44,0x39,0x74, 0x44,0x3e,0x45, 0x45,0x2,0x45, 0x45,0x9,0x45, 0x45,0x19,0x45, 0x45,0x21,0x45, 0x45,0x24,0x44, 0x45,0x29,0x45, 0x45,0x30,0x45, 0x45,0x3e,0x46, 0x46,0x5,0x45, 0x46,0x8,0x46, 0x46,0xb,0x44, 0x46,0xd,0x46, 0x46,0x14,0x79, 0x46,0x29,0x46, 0x46,0x30,0x46, 0x46,0x37,0x45, 0x46,0x3e,0x47, 0x47,0x4,0x47, 0x47,0xc,0x47, 0x47,0x10,0x45, 0x47,0x12,0x47, 0x47,0x14,0x44, 0x47,0x21,0x46, 0x47,0x31,0x47, 0x47,0x34,0x48, 0x47,0x3a,0x48, 0x47,0x3e,0x48, 0x48,0x1,0x45, 0x48,0x6,0x47, 0x48,0xf,0x79, 0x48,0x20,0x47, 0x48,0x26,0x48, 0x48,0x2d,0x48, 0x48,0x34,0x47, 0x48,0x39,0x63, 0x48,0x3b,0x48, 0x48,0x3e,0x49, 0x49,0x1,0x43, 0x49,0x3,0x5, 0x49,0x7,0x1d, 0x49,0xc,0x49, 0x49,0xe,0x26, 0x49,0x10,0x49, 0x49,0x3e,0x4a, 0x4a,0x11,0x61, 0x4a,0x21,0x4a, 0x4a,0x23,0x61, 0x4a,0x2f,0x4a, 0x4a,0x3e,0x4b, 0x4b,0x10,0x4b, 0x4b,0x1b,0x4b, 0x4b,0x3e,0x4c, 0x4c,0x1f,0x4c, 0x4c,0x21,0x51, 0x4c,0x38,0x49, 0x4c,0x3e,0x4d, 0x4d,0xb,0x49, 0x4d,0x1c,0x49, 0x4d,0x2b,0x49, 0x4d,0x34,0x4e, 0x4d,0x3e,0x4e, 0x4e,0x9,0x49, 0x4e,0xb,0x4d, 0x4e,0x15,0x4e, 0x4e,0x2a,0x49, 0x4e,0x2c,0x4e, 0x4e,0x35,0x4f, 0x4e,0x3e,0x4f, 0x4f,0xc,0x49, 0x4f,0xe,0x4e, 0x4f,0x11,0x49, 0x4f,0x16,0x4a, 0x4f,0x1c,0x4f, 0x4f,0x1e,0x51, 0x4f,0x29,0x49, 0x4f,0x2e,0x4a, 0x4f,0x38,0x4f, 0x4f,0x3a,0x51, 0x4f,0x3e,0x50, 0x50,0x0,0x49, 0x50,0x5,0x4a, 0x50,0x9,0x51, 0x50,0xd,0x49, 0x50,0x12,0x4a, 0x50,0x16,0x51, 0x50,0x1a,0x49, 0x50,0x2b,0x51, 0x50,0x31,0x51, 0x50,0x33,0x4a, 0x50,0x36,0x51, 0x50,0x3e,0x51, 0x51,0x1,0x49, 0x51,0x6,0x50, 0x51,0x8,0x4a, 0x51,0xc,0x51, 0x51,0x11,0x4a, 0x51,0x14,0x51, 0x51,0x21,0x51, 0x51,0x2b,0x52, 0x51,0x2e,0x52, 0x51,0x35,0x62, 0x51,0x38,0x4b, 0x51,0x3a,0x4c, 0x51,0x3e,0x52, 0x52,0x38,0x56, 0x52,0x3e,0x53, 0x53,0x0,0x4b, 0x53,0x6,0x62, 0x53,0x16,0x52, 0x53,0x28,0x53, 0x53,0x3e,0x54, 0x54,0x0,0x4b, 0x54,0x8,0x2c, 0x54,0xe,0x62, 0x54,0x15,0x2c, 0x54,0x1b,0x62, 0x54,0x24,0x2c, 0x54,0x2a,0x62, 0x54,0x31,0x2c, 0x54,0x37,0x62, 0x54,0x3a,0x4b, 0x54,0x3e,0x55, 0x55,0x8,0x55, 0x55,0x1b,0x4b, 0x55,0x22,0x55, 0x55,0x28,0x62, 0x55,0x2a,0x53, 0x55,0x32,0x56, 0x55,0x3e,0x56, 0x56,0x17,0x56, 0x56,0x3e,0x57, 0x57,0x22,0x4b, 0x57,0x3e,0x58, 0x58,0xa,0x57, 0x58,0x24,0x58, 0x58,0x39,0x57, 0x58,0x3e,0x59, 0x59,0xc,0x58, 0x59,0x16,0x58, 0x59,0x1c,0x59, 0x59,0x28,0x59, 0x59,0x32,0x58, 0x59,0x38,0x5a, 0x59,0x3e,0x5a, 0x5a,0x1,0x5a, 0x5a,0x12,0x48, 0x5a,0x1b,0x48, 0x5a,0x3e,0x5b, 0x5b,0x10,0x4b, 0x5b,0x21,0x5b, 0x5b,0x24,0x44, 0x5b,0x27,0x6e, 0x5b,0x2e,0x5b, 0x5b,0x3e,0x5c, 0x5c,0x1f,0x57, 0x5c,0x26,0x5c, 0x5c,0x3e,0x5d, 0x5d,0xc,0x57, 0x5d,0x2d,0x5e, 0x5d,0x3e,0x5e, 0x5e,0x0,0x57, 0x5e,0x12,0x5d, 0x5e,0x20,0x5d, 0x5e,0x24,0x6e, 0x5e,0x29,0x47, 0x5e,0x3e,0x5f, 0x5f,0xa,0x46, 0x5f,0x10,0x5e, 0x5f,0x14,0x44, 0x5f,0x1a,0x46, 0x5f,0x20,0x5a, 0x5f,0x24,0x44, 0x5f,0x28,0x5a, 0x5f,0x2b,0x5a, 0x5f,0x3e,0x60, 0x60,0x0,0x5e, 0x60,0x3,0x5c, 0x60,0x8,0x60, 0x60,0xe,0x62, 0x60,0x10,0x60, 0x60,0x15,0x5c, 0x60,0x31,0x60, 0x60,0x36,0x61, 0x60,0x3e,0x61, 0x61,0x3e,0x62, 0x62,0x2,0x62, 0x62,0x7,0x62, 0x62,0x1d,0x62, 0x62,0x28,0x61, 0x62,0x31,0x63, 0x62,0x33,0x6e, 0x62,0x35,0x61, 0x62,0x3e,0x63, 0x63,0x2,0x62, 0x63,0xb,0x62, 0x63,0x3e,0x64, 0x64,0x3e,0x65, 0x65,0x15,0x39, 0x65,0x1c,0x39, 0x65,0x30,0x36, 0x65,0x35,0x36, 0x65,0x3e,0x66, 0x66,0x7,0x66, 0x66,0xd,0x66, 0x66,0x12,0x66, 0x66,0x14,0x66, 0x66,0x19,0x66, 0x66,0x1e,0x66, 0x66,0x23,0x66, 0x66,0x28,0x66, 0x66,0x35,0x65, 0x66,0x3e,0x67, 0x67,0x2,0x67, 0x67,0x6,0x67, 0x67,0xb,0x67, 0x67,0x11,0x67, 0x67,0x17,0x67, 0x67,0x21,0x67, 0x67,0x29,0x67, 0x67,0x2b,0x69, 0x67,0x2e,0x67, 0x67,0x3e,0x68, 0x68,0x2,0x69, 0x68,0xa,0x69, 0x68,0x12,0x69, 0x68,0x1a,0x69, 0x68,0x22,0x69, 0x68,0x2a,0x69, 0x68,0x33,0x68, 0x68,0x36,0x69, 0x68,0x3e,0x69, 0x69,0x2,0x68, 0x69,0x4,0x69, 0x69,0xa,0x66, 0x69,0xe,0x69, 0x69,0x1e,0x69, 0x69,0x22,0x6a, 0x69,0x27,0x6a, 0x69,0x2d,0x69, 0x69,0x33,0x69, 0x69,0x3e,0x6a, 0x6a,0x0,0x6a, 0x6a,0x8,0x6a, 0x6a,0xb,0x6a, 0x6a,0x1a,0x6a, 0x6a,0x23,0x6a, 0x6a,0x2d,0x6a, 0x6a,0x32,0x66, 0x6a,0x3e,0x6b, 0x6b,0x7,0x66, 0x6b,0x2a,0x6c, 0x6b,0x36,0x6c, 0x6b,0x3e,0x6c, 0x6c,0x2,0x6c, 0x6c,0x22,0x26, 0x6c,0x37,0x25, 0x6c,0x3e,0x6d, 0x6d,0x2,0x6d, 0x6d,0x3e,0x6e, 0x6e,0xd,0x6e, 0x6e,0xf,0x71, 0x6e,0x18,0x6e, 0x6e,0x27,0x6f, 0x6e,0x2f,0x6f, 0x6e,0x35,0x6f, 0x6e,0x3c,0x6f, 0x6e,0x3e,0x6f, 0x6f,0x4,0x70, 0x6f,0xa,0x70, 0x6f,0x10,0x6f, 0x6f,0x16,0x6f, 0x6f,0x1a,0x6f, 0x6f,0x23,0x6e, 0x6f,0x29,0x70, 0x6f,0x31,0x70, 0x6f,0x39,0x70, 0x6f,0x3e,0x70, 0x70,0x0,0x70, 0x70,0x8,0x71, 0x70,0x13,0x71, 0x70,0x1c,0x70, 0x70,0x2e,0x70, 0x70,0x3e,0x71, 0x71,0x2,0x71, 0x71,0xa,0x71, 0x71,0x13,0x71, 0x71,0x1d,0x71, 0x71,0x2a,0x71, 0x71,0x2c,0x74, 0x71,0x39,0x72, 0x71,0x3e,0x72, 0x72,0x9,0x73, 0x72,0xf,0x74, 0x72,0x18,0x72, 0x72,0x23,0x73, 0x72,0x26,0x72, 0x72,0x32,0x73, 0x72,0x3e,0x73, 0x73,0x8,0x73, 0x73,0xe,0x74, 0x73,0x1d,0x73, 0x73,0x35,0x73, 0x73,0x39,0x73, 0x73,0x3e,0x74, 0x74,0xb,0x74, 0x74,0x10,0x74, 0x74,0x16,0x74, 0x74,0x25,0x88, 0x74,0x2c,0x74, 0x74,0x2e,0x6e, 0x74,0x30,0x78, 0x74,0x3c,0x75, 0x74,0x3e,0x75, 0x75,0x0,0x78, 0x75,0xa,0x75, 0x75,0x10,0x75, 0x75,0x12,0x78, 0x75,0x1b,0x75, 0x75,0x1d,0x78, 0x75,0x28,0x71, 0x75,0x2a,0x78, 0x75,0x3e,0x76, 0x76,0x2,0x76, 0x76,0x4,0x77, 0x76,0xa,0x77, 0x76,0x17,0x77, 0x76,0x2a,0x76, 0x76,0x33,0x77, 0x76,0x3e,0x77, 0x77,0x4,0x77, 0x77,0xb,0x78, 0x77,0x11,0x78, 0x77,0x1a,0x77, 0x77,0x22,0x75, 0x77,0x2c,0x78, 0x77,0x32,0x78, 0x77,0x3c,0x78, 0x77,0x3e,0x78, 0x78,0xc,0x78, 0x78,0x15,0x78, 0x78,0x17,0x6e, 0x78,0x1d,0x78, 0x78,0x21,0x78, 0x78,0x24,0x71, 0x78,0x27,0x78, 0x78,0x2a,0x78, 0x78,0x31,0x89, 0x78,0x34,0x89, 0x78,0x38,0x78, 0x78,0x3e,0x79, 0x79,0x2,0x78, 0x79,0xc,0x79, 0x79,0x13,0x88, 0x79,0x26,0x79, 0x79,0x2f,0x89, 0x79,0x35,0x88, 0x79,0x3e,0x7a, 0x7a,0x1,0x84, 0x7a,0x11,0x7a, 0x7a,0x13,0x84, 0x7a,0x18,0x7a, 0x7a,0x22,0x7a, 0x7a,0x26,0x84, 0x7a,0x28,0x7a, 0x7a,0x30,0x7b, 0x7a,0x35,0x7b, 0x7a,0x39,0x7b, 0x7a,0x3e,0x7b, 0x7b,0x2,0x7b, 0x7b,0x7,0x7b, 0x7b,0xa,0x7c, 0x7b,0xf,0x7b, 0x7b,0x14,0x7b, 0x7b,0x17,0x7c, 0x7b,0x1b,0x7c, 0x7b,0x1e,0x7c, 0x7b,0x21,0x7c, 0x7b,0x28,0x7b, 0x7b,0x2b,0x7b, 0x7b,0x32,0x7c, 0x7b,0x3a,0x7c, 0x7b,0x3e,0x7c, 0x7c,0x2,0x7c, 0x7c,0x5,0x84, 0x7c,0x8,0x7c, 0x7c,0xd,0x7c, 0x7c,0x10,0x7c, 0x7c,0x15,0x7c, 0x7c,0x1e,0x7a, 0x7c,0x26,0x7c, 0x7c,0x2c,0x7d, 0x7c,0x31,0x7d, 0x7c,0x36,0x7d, 0x7c,0x3b,0x7d, 0x7c,0x3e,0x7d, 0x7d,0x0,0x7e, 0x7d,0x2,0x7d, 0x7d,0xd,0x7d, 0x7d,0x17,0x7d, 0x7d,0x1b,0x7d, 0x7d,0x21,0x84, 0x7d,0x28,0x7e, 0x7d,0x32,0x7d, 0x7d,0x36,0x7d, 0x7d,0x3c,0x84, 0x7d,0x3e,0x7e, 0x7e,0x6,0x7e, 0x7e,0xe,0x7e, 0x7e,0x13,0x84, 0x7e,0x16,0x7e, 0x7e,0x20,0x84, 0x7e,0x2b,0x7e, 0x7e,0x2d,0x83, 0x7e,0x32,0x7e, 0x7e,0x37,0x7f, 0x7e,0x3b,0x7f, 0x7e,0x3e,0x7f, 0x7f,0x5,0x7f, 0x7f,0x12,0x7f, 0x7f,0x20,0x85, 0x7f,0x24,0x81, 0x7f,0x29,0x7f, 0x7f,0x2f,0x80, 0x7f,0x37,0x80, 0x7f,0x3b,0x80, 0x7f,0x3e,0x80, 0x80,0x2,0x80, 0x80,0x4,0x84, 0x80,0x9,0x80, 0x80,0xe,0x80, 0x80,0x10,0x84, 0x80,0x16,0x80, 0x80,0x1b,0x80, 0x80,0x1e,0x80, 0x80,0x23,0x80, 0x80,0x27,0x80, 0x80,0x2b,0x80, 0x80,0x31,0x80, 0x80,0x39,0x81, 0x80,0x3e,0x81, 0x81,0x4,0x85, 0x81,0xc,0x81, 0x81,0x13,0x81, 0x81,0x16,0x81, 0x81,0x19,0x81, 0x81,0x1d,0x81, 0x81,0x21,0x81, 0x81,0x24,0x81, 0x81,0x28,0x81, 0x81,0x31,0x81, 0x81,0x34,0x82, 0x81,0x37,0x82, 0x81,0x3b,0x82, 0x81,0x3e,0x82, 0x82,0x3,0x82, 0x82,0x7,0x82, 0x82,0xa,0x82, 0x82,0x10,0x82, 0x82,0x18,0x82, 0x82,0x1e,0x84, 0x82,0x22,0x82, 0x82,0x27,0x82, 0x82,0x2a,0x82, 0x82,0x2e,0x83, 0x82,0x34,0x84, 0x82,0x38,0x83, 0x82,0x3b,0x83, 0x82,0x3e,0x83, 0x83,0x1,0x83, 0x83,0x6,0x83, 0x83,0xc,0x83, 0x83,0xf,0x83, 0x83,0x12,0x83, 0x83,0x19,0x84, 0x83,0x1e,0x83, 0x83,0x23,0x84, 0x83,0x26,0x83, 0x83,0x2f,0x84, 0x83,0x32,0x83, 0x83,0x37,0x83, 0x83,0x39,0x7a, 0x83,0x3e,0x84, 0x84,0x0,0x84, 0x84,0x3,0x83, 0x84,0x8,0x84, 0x84,0xe,0x89, 0x84,0x11,0x84, 0x84,0x20,0x84, 0x84,0x2e,0x84, 0x84,0x3e,0x85, 0x85,0x1,0x85, 0x85,0x5,0x85, 0x85,0x8,0x85, 0x85,0x12,0x85, 0x85,0x1c,0x85, 0x85,0x25,0x85, 0x85,0x39,0x86, 0x85,0x3e,0x86, 0x86,0x2,0x87, 0x86,0xd,0x87, 0x86,0x10,0x87, 0x86,0x21,0x87, 0x86,0x25,0x86, 0x86,0x31,0x86, 0x86,0x3a,0x87, 0x86,0x3e,0x87, 0x87,0x2,0x86, 0x87,0x4,0x86, 0x87,0xc,0x87, 0x87,0x12,0x87, 0x87,0x16,0x87, 0x87,0x18,0x86, 0x87,0x23,0x87, 0x87,0x34,0x87, 0x87,0x3e,0x88, 0x88,0x3,0x88, 0x88,0xf,0x88, 0x88,0x1c,0x88, 0x89,0x27,0x89, 0x89,0x2a,0x89, 0x89,0x31,0x89, 0x74,0x63,0x74, 0x79,0x51,0x79, 0x79,0x73,0x79, 0x8c,0xed,0x20, 0x8c,0xee,0x21, 0x8c,0xef,0x21, 0x8c,0xf0,0x21, 0x8c,0xf1,0x21, 0x8c,0xf2,0x21, 0x8c,0xf5,0x27, 0x8c,0xf6,0x2b, 0x8c,0xf7,0x25, 0x8c,0xf8,0x25, 0x8c,0xf9,0x25, 0x8c,0xfa,0x26, 0x8d,0x8c,0x57, 0x8d,0x8d,0x2b, 0x8d,0x8e,0x59, 0x8d,0x8f,0x59, 0x8d,0x90,0x59, 0x8d,0x91,0x57, 0x8d,0x94,0x64, 0x8d,0x95,0x2b, 0x8d,0x96,0x66, 0x8d,0x97,0x69, 0x8d,0x98,0x6a, 0x4,0xa1,0x1a, 0x4,0xa2,0x24, 0x4,0xa3,0x56, 0x4,0xa4,0x6b, 0x4,0xa5,0x6d, 0x4,0xa6,0x1b };
#define NUM_PAGES 142
#define numOffsets 3417
#define lastRandomizablePage 136

/* If needed, NUM_NEWPOSITIONS must be NUM_PAGES +1, to store an extra 16bit integer counting the miliseconds. Uncomment below if needed
#define NUM_NEWPOSITIONS 143
*/

//---------- END: COPIED FROM OUTPUT OF PYTHON SCRIPT WHICH PREPROCESSES THE HEX FILE-------------

/*Uncomment to get timer in EEPROM
uint16_t newPositions[NUM_NEWPOSITIONS];
	*/

uint16_t newPositions[NUM_PAGES];

uint16_t seed=1;  // These two variables can be reused in your program after the
volatile int8_t nrot;    // function CreateTrulyRandomSeed()executes in the setup() 
                         // function.

//Creates a shift, using the jitter variance between the Watchdog and the system timer. See https://sites.google.com/site/astudyofentropy/home for more info
void createSeed()
{
  seed = 2;
  nrot = 32; // Must be at least 2, but more increased the uniformity of the produced 
             // seeds entropy.
  
  // Turn on the watch dog timer interrupt to create the seed value
  cli();                                             
  MCUSR = 0;                                         
  _WD_CONTROL_REG |= (1<<_WD_CHANGE_BIT) | (1<<WDE); 
  _WD_CONTROL_REG = (1<<WDIE);                       
  sei();                                             
 
  while (nrot > 0);  // wait here until seed is created
 
  // Turn off the watch dog timer interrupt
  cli();                                             
  MCUSR = 0;                                         
  _WD_CONTROL_REG |= (1<<_WD_CHANGE_BIT) | (0<<WDE); 
  _WD_CONTROL_REG = (0<< WDIE);                      
  sei();                                             
}
//Watchdog Interrupt, decrease the nrot variable and update the seed using the jitter of the system timer 1 (TCNT1L)
ISR(WDT_vect)
{
  nrot--;
  seed = seed << 8;
  seed = seed ^ TCNT1L;
}

//Given the new page and the current PC address, returns a new PC address pointing at the new page
uint16_t modifyPage (uint8_t pc_h, uint8_t pc_l, uint8_t newPage){
	uint16_t wd = ((uint16_t)pc_h << 8) | pc_l;
	uint8_t p=wd & 0x003F;
	uint16_t q=wd & 0xFFE0;
	q=q>>5;

	uint16_t new_H=((uint16_t)newPage)>>2;
	uint16_t new_L=(uint16_t)(((uint8_t)newPage & 0x03)<<6 | p);
	uint16_t newPC=new_H<<8 | new_L;
	return newPC;
}

//Returns the lower bytes for JMP and CALL instructions
void getOpcodeJMP_CALL(uint8_t newPage,uint8_t* data, uint8_t offsetPage){

  	uint8_t pc_l=data[offsetPage+2];
  	uint8_t pc_h=data[offsetPage+3];

  	uint16_t address=modifyPage(pc_h,pc_l,newPage);
  	uint8_t first=(address & 0xFF00)>>8;
  	uint8_t second=(address & 0x00FF);
	data[offsetPage+2]=second;
	data[offsetPage+3]=first;
}

//Returns the opcode for a prologue pointer
void getOpcodePrologues(uint8_t newPage,uint8_t* data, uint8_t offsetPage){
	uint8_t pc_l=(data[offsetPage] & 0x0F) | ((data[offsetPage+1] & 0x0F)<<4);
  	uint8_t pc_h=(data[offsetPage+2] & 0x0F) | ((data[offsetPage+3] & 0x0F)<<4);

  	uint16_t address=modifyPage(pc_h,pc_l,newPage);
  	uint8_t first=(address & 0xFF00)>>8;
  	uint8_t second=(address & 0x00FF);

  	data[offsetPage]=(second & 0x0F)| 0xE0;
  	data[offsetPage+1]=(second & 0xF0)>>4 | 0xE0;
  	data[offsetPage+2]=(first & 0x0F) | 0xF0;
  	data[offsetPage+3]=(first & 0xF0)>>4 | 0xE0;
}

//Return the opcode of vpointers
void getOpcodeVpointerOrCtors(uint8_t newPage,uint8_t* data, uint8_t offsetPage){

	uint8_t pc_l=data[offsetPage];
  	uint8_t pc_h=data[offsetPage+1];
  	uint16_t address=modifyPage(pc_h,pc_l,newPage);
  	uint8_t first=(address & 0xFF00)>>8;
  	uint8_t second=(address & 0x00FF);
	data[offsetPage]=second;
	data[offsetPage+1]=first;
}

//Given a page, which has been read from program memory and stored in SRAM, updates all the pointers that it contains
void updatePointersPage(uint8_t page,uint8_t* data){
  short i;
  uint8_t pageNumber;
  uint8_t offsetPage;
  uint8_t destPage;
 // uint8_t destOffsetPage;
  uint8_t type;
  //uint16_t newDest;
  for (i=0;i<numOffsets;i+=3){
      pageNumber=pgm_read_byte(pageOffsets+i);
      offsetPage=(pgm_read_byte(pageOffsets+i+1) & 0x3F)*2;
      destPage=pgm_read_byte(pageOffsets+i+2);
      //destOffsetPage=pgm_read_byte(pageOffsets+i+3);
      type=(pgm_read_byte(pageOffsets+i+1) & 0xC0)>>6;
      if (pageNumber==page){
          //newDest=newPositions[destPage]+destOffsetPage;
          switch (type){
          	case 0://JMP
          		getOpcodeJMP_CALL(newPositions[destPage]/SPM_PAGESIZE,data,offsetPage);          		
          		break;
/*          	case 1://CALL
          		getOpcodeJMP_CALL(newPositions[destPage]/SPM_PAGESIZE,data,offsetPage);
          		break;*/
          	case 1://PROLOGUES
          		getOpcodePrologues(newPositions[destPage]/SPM_PAGESIZE,data,offsetPage);      		
          		break;
          	case 2://GLOBAL_CTORS or VPOINTER_EVEN
          		getOpcodeVpointerOrCtors(newPositions[destPage]/SPM_PAGESIZE,data,offsetPage);
          		break;
          	case 3://VPOINTER_ODD
          		getOpcodeVpointerOrCtors(newPositions[destPage]/SPM_PAGESIZE,data,offsetPage+1);
          		break;
          	/*case 4://VPOINTER
          		getOpcodeVpointerOrCtors(newPositions[destPage]/SPM_PAGESIZE,data,offsetPage);
          		break;*/
          }
      }
  }
}
// Random algorithm obtained from rand() libc
static uint16_t myRand(uint16_t max,uint16_t *ctx){
	uint16_t hi, lo, x;

	/* Can't be initialized with 0, so use another value. */
	if (*ctx == 0)
		*ctx = 123459;
	hi = *ctx / 127773;
	//lo = *ctx % 127773;
	lo=*ctx-1277773*hi;
	x = 16807 * lo - 2836 * hi;
	if (x < 0)
		x += 0x7fffffff;
	*ctx=x;
	//return ((*ctx = x) % (max + 1));
	//return x%(max+1)
	return x-(max+1)*(x/(max+1));
}
// It returns a random permutation swap of 0..n-1
void calculateNewPagePositions(uint8_t n,uint8_t *a) {
    uint16_t k;
    uint8_t haveRand[n];
    uint16_t j;
    for (k = n-1; k > 0; k--){
		a[k] = k;
		haveRand[k]=0;
	}
    for (k = lastRandomizablePage-1; k > 5; k--) {
    	if (haveRand[k]==0){
    		uint8_t tries=0;
			do{
				j=myRand(k+1,&seed);
				tries++;
			}while((haveRand[j]==1 || j==k || j<=5 || j>=lastRandomizablePage)&& tries<5);
			if (tries<5){
				//uint16_t temp = a[j];
				a[j] = a[k];
				a[k] = n+1;
				
				uint16_t temp=newPositions[j];
				newPositions[j]=newPositions[k];
				newPositions[k]=temp;

				haveRand[j]=1;
				haveRand[k]=1;
			}
		}
    }
}
void writeSwappedPages(uint8_t page1,uint8_t page2,uint16_t offset1,uint16_t offset2){
	uint8_t i;
	uint8_t dataPage1 [SPM_PAGESIZE];
	uint8_t dataPage2 [SPM_PAGESIZE];
	//READ PAGE 1 INTO A AND UPDATE ITS POINTERS
	for ( i = 0; i < SPM_PAGESIZE; i++,offset1++,offset2++){
		dataPage1 [i] = pgm_read_byte (offset1);
		dataPage2 [i] = pgm_read_byte (offset2);
	}
	updatePointersPage(page1,dataPage1/*,newPositions*/);
	boot_program_page(newPositions[page1],dataPage1);

	updatePointersPage(page2,dataPage2/*,newPositions*/);
	boot_program_page(newPositions[page2],dataPage2);

}
/*Uncomment to get timer in EEPROM
ISR(TIMER1_COMPA_vect, ISR_BLOCK)
{
	TCNT1H = 0;
	TCNT1L = 0;
	newPositions[NUM_PAGES]++;
}*/


/** Main task to randomize the binary code
 */
void randomizeBinary(void)
{
	uint8_t A [SPM_PAGESIZE];
	uint8_t numPage=0;
	uint8_t i;
	uint16_t offset;
	uint8_t randomPermutation [NUM_PAGES];
	
	/*Uncomment to get timer in EEPROM
	eeprom_read_block((void*)&newPositions,  (const void*)0, NUM_NEWPOSITIONS*2);
	newPositions[NUM_PAGES]=0;
	*/

	//Gets the current positions from EEPROM and stores temporarly in SRAM (i.e. buffer new_positions)
	eeprom_read_block((void*)&newPositions,  (const void*)0, NUM_PAGES*2);

	//Initialize timer
	/*Uncomment to get timer in EEPROM
	//Generates interrupt every 1 ms
	OCR1AH = 0;
	OCR1AL = 250;
	TIMSK1 = (1 << OCIE1A);					// enable timer 1 output compare A match interrupt
	*/

	//Initialize Timer 1
	TCCR1B = ((1 << CS11) | (1 << CS10));	// 1/64 prescaler on timer 1 input
	
	//Gets the initial seed, using the jitter variance between system clock and watchdog oscillator
	createSeed();

	//Calculates the map of random swaps
	calculateNewPagePositions(NUM_PAGES,randomPermutation);

	//Iterates through the program binary
	for (numPage=0;numPage<NUM_PAGES;numPage++){
		//If the random swap has a valid interchangeable page...
		if (randomPermutation[numPage]<NUM_PAGES+1){
			//.. and if this page is not itself...
			if (randomPermutation[numPage]!=numPage){
				uint16_t swappedPage=randomPermutation[numPage];
				offset=eeprom_read_word((uint16_t*)(numPage*2));
				uint16_t offset2=eeprom_read_word((uint16_t*)(swappedPage*2));
				// Swap pages
				writeSwappedPages(numPage,swappedPage,offset,offset2);
			}else{//Page must be written as it is (i.e. not interchanged)
				//Reads the current offset, and stores the page in SRAM memory (i.e. A buffer)
				offset=eeprom_read_word((uint16_t*)(numPage*2));
				for ( i = 0; i < SPM_PAGESIZE; i++,offset++){
					A [i] = pgm_read_byte (offset);
				}
				//Updates the pointers according to the new positions
				updatePointersPage(numPage,A);
				// Store page in program memory
				boot_program_page(newPositions[numPage],A);
			}
		}else{	
		// If the random swap map indicates a number greater than NUM_PAGES, means that it been swapped with a previous page, 
		// In this case, it must not be swapped again. 
		//do_nothing!()
		}
	}
	/*Uncomment to get timer in EEPROM
	eeprom_write_block((const void*)&newPositions, (void*)0, NUM_NEWPOSITIONS*2);
	*/

	//Writes the newPositions (private_data) in EEPROM
	eeprom_write_block((const void*)&newPositions, (void*)0, NUM_PAGES*2);

}
